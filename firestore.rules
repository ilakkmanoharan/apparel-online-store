rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Public catalog – allow anyone to read (needed for home, PLP, PDP, nav)
    match /products/{productId} {
      allow read: if true;
      allow write: if false;
    }
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if false;
      match /gallery/{itemId} {
        allow read: if true;
        allow write: if false;
      }
    }

    // Editorial / marketing – public read
    match /campaigns/{id} {
      allow read: if true;
      allow write: if false;
    }
    match /banners/{id} {
      allow read: if true;
      allow write: if false;
    }

    // Stores – public read
    match /stores/{id} {
      allow read: if true;
      allow write: if false;
    }

    // Product QA and productReviews – public read, authenticated write
    match /productQA/{id} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if false;
    }
    match /productReviews/{id} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if false;
    }

    // Orders – only the owning user can read; create/update only via backend (webhook)
    match /orders/{orderId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update, delete: if false;
    }

    // User-private data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      match /addresses/{addressId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Promos – public read (validate code), write via admin only (no client write)
    match /promos/{id} {
      allow read: if true;
      allow write: if false;
    }

    // Gift cards – read by code (redeem/balance); write server-only
    match /giftCards/{id} {
      allow read: if true;
      allow write: if false;
    }

    // Loyalty, BOPIS, returns, user coupons, store credit – require auth
    match /loyaltyBalances/{id} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    match /loyaltyTransactions/{id} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    match /bopisReservations/{id} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    match /returns/{id} {
      allow read, write: if request.auth != null;
    }
    match /userCoupons/{id} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    match /storeCredit/{id} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // User preferences and spend (doc id = userId)
    match /userPreferences/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /userSpend/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Admin / internal – client has no access (admin uses backend)
    match /auditLog/{id} {
      allow read, write: if false;
    }

    // Default: deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
